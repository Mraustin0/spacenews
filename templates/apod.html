<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NASA APOD</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=The+Seasons:wght@400;700&display=swap" rel="stylesheet">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', Arial, Helvetica, sans-serif;
    background: #080b11;
    color: #fff;
    line-height: 1.6;
    min-height: 100vh;
}

h1, h2, h3, h4, h5, h6 {
    font-family: 'The Seasons', serif;
}

/* Navigation */
nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(18, 20, 28, 0.92);
    backdrop-filter: blur(14px);
    padding: 16px 32px;
    position: sticky;
    top: 0;
    z-index: 120;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.breadcrumb {
    max-width: 900px;
    margin: 24px auto 0 auto;
    padding: 0 20px;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.breadcrumb a {
    color: rgba(245, 245, 245, 0.55);
    text-decoration: none;
    transition: color 0.2s ease;
}
.breadcrumb a:hover {
    color: #ffffff;
}
.breadcrumb span {
    color: #ffffff;
    font-weight: 600;
}

.site-footer {
    margin-top: 60px;
    padding: 28px 16px;
    border-top: 1px solid rgba(255,255,255,0.08);
    text-align: center;
    color: rgba(245,245,245,0.6);
    font-size: 13px;
    letter-spacing: 0.05em;
}
.site-footer a {
    color: rgba(245,245,245,0.75);
    text-decoration: none;
}
.site-footer a:hover {
    color: #f87171;
}
.nav-left,
.nav-center,
.nav-right {
    display: flex;
    align-items: center;
}
.nav-left {
    gap: 12px;
}
.nav-left img {
    height: 28px;
}
.nav-left .logo {
    font-family: 'The Seasons', serif;
    font-size: 18px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #f5f5f5;
    text-decoration: none;
}
.nav-center {
    gap: 24px;
}
.nav-center a {
    color: rgba(245, 245, 245, 0.84);
    text-decoration: none;
    font-size: 14px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 500;
    transition: color 0.2s ease;
}
.nav-center a:hover,
.nav-center a.active {
    color: #f87171;
}
.dropdown {
    position: relative;
}
.dropbtn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.dropbtn::after {
    content: '\25BE';
    font-size: 11px;
    transition: transform 0.2s ease;
}
.dropdown:hover .dropbtn::after {
    transform: rotate(-180deg);
}
.dropdown-content {
    position: absolute;
    top: calc(100% + 10px);
    left: 0;
    background: rgba(14, 16, 24, 0.96);
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    min-width: 190px;
    padding: 10px 0;
    box-shadow: 0 18px 36px rgba(0,0,0,0.45);
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
    z-index: 200;
}
.dropdown:hover .dropdown-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.dropdown-content a {
    display: block;
    padding: 10px 18px;
    color: rgba(245,245,245,0.78);
    text-decoration: none;
    font-size: 12px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: background 0.2s ease, color 0.2s ease;
}
.dropdown-content a:hover {
    background: rgba(248,113,113,0.12);
    color:#f87171;
}
.nav-right {
    gap: 16px;
}
.nav-right span {
    color: rgba(245,245,245,0.68);
    font-size: 13px;
    letter-spacing: 0.05em;
}
.nav-right a {
    color: rgba(245,245,245,0.84);
    text-decoration: none;
    font-size: 14px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    font-weight: 500;
    padding: 8px 18px;
    border-radius: 999px;
    border: 1px solid transparent;
    transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
}
.nav-right a:hover {
    border-color: rgba(248,113,113,0.6);
    color: #f87171;
}
.nav-right .primary-action {
    border-color: rgba(248,113,113,0.65);
    color: #f87171;
}
.nav-right .primary-action:hover {
    background: #f87171;
    color: #111;
}

@media (max-width: 900px) {
    nav {
        flex-direction: column;
        align-items: flex-start;
        gap: 18px;
    }
    .nav-center, .nav-right {
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }
    .nav-right {
        justify-content: flex-end;
    }
}

/* Main Container */
.main-container {
    max-width: 900px;
    margin: 4px auto 20px auto;
    padding: 0 20px;
}

/* APOD Layout */
.apod-container {
    background: #000;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    overflow: hidden;
    transition: box-shadow 0.3s ease;
    margin-bottom: 40px;
}



.apod-header {
    padding: 8px 24px 12px 24px;
    text-align: center;
    border-bottom: 1px solid #333;
}

.apod-header h1 {
    font-size: 28px;
    font-weight: 600;
    color: #fff;
    letter-spacing: -0.5px;
}

.apod-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px 20px 30px;
    color: #aaa;
    font-weight: 500;
    font-size: 16px;
}

.apod-image-container {
    width: 100%;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
}

.apod-image, .apod-video {
    width: 100%;
    height: auto;
    max-height: 600px;
    object-fit: contain;
    display: block;
    transition: transform 0.3s ease;
}

.action-buttons {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 12px;
}

.icon-button {
    width: 48px;
    height: 48px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    background: rgba(10, 12, 18, 0.7);
    color: #f5f5f5;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    text-decoration: none;
}

.icon-button svg {
    width: 20px;
    height: 20px;
}

.icon-button:hover {
    background: rgba(20, 23, 32, 0.85);
    border-color: rgba(255, 255, 255, 0.32);
    transform: translateY(-2px);
}

.icon-button.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
    transform: none;
}

.action-buttons {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 12px;
}

.icon-button {
    width: 48px;
    height: 48px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    background: rgba(10, 12, 18, 0.7);
    color: #f5f5f5;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    text-decoration: none;
}

.icon-button svg {
    width: 20px;
    height: 20px;
}

.icon-button:hover {
    background: rgba(20, 23, 32, 0.85);
    border-color: rgba(255, 255, 255, 0.32);
    transform: translateY(-2px);
}

.icon-button:disabled {
    opacity: 0.5;
    cursor: default;
    transform: none;
}

/* Removed hover transform on .apod-image */
/* .apod-image:hover {
    transform: scale(1.02);
} */

/* Explanation Card */
.apod-explanation {
    background: #000;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    padding: 26px 28px 34px 28px;
    max-width: 900px;
    margin: 24px auto 50px auto;
    color: #fff;
    line-height: 1.75;
    font-size: 17px;
}

.apod-explanation h3 {
    font-size: 24px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
}

.apod-explanation h3::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 2px;
    background: #1e90ff;
    border-radius: 2px;
}

/* Loading State */
.loading {
    text-align: center;
    padding: 60px 20px;
    color: #aaa;
    font-size: 18px;
}

/* Removed spinner animation */
/* .loading::before {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #444;
    border-top: 3px solid #1e90ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
} */

/* @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
} */

/* Updated nav-right styles for Register and Login buttons */
.nav-right a {
    font-weight: 500;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
    text-decoration: none;
    display: inline-block;
    background-color: transparent !important;
    color: #fff !important;
    border: none !important;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(4, 5, 8, 0.78);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(6px);
}

.modal-overlay.open {
    display: flex;
}

.modal-card {
    background: rgba(16, 18, 27, 0.95);
    border-radius: 16px;
    padding: 28px 32px;
    max-width: 360px;
    width: 90%;
    box-shadow: 0 18px 36px rgba(0, 0, 0, 0.55);
    text-align: center;
}

.modal-card p {
    margin: 0 0 24px 0;
    color: rgba(245, 245, 245, 0.9);
    line-height: 1.6;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
}

.modal-button {
    min-width: 96px;
    padding: 10px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: transparent;
    color: #f5f5f5;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease;
}

.modal-button:hover {
    background: rgba(35, 38, 51, 0.9);
    border-color: rgba(255, 255, 255, 0.4);
}

@media (max-width: 768px) {
    .action-buttons {
        position: static;
        justify-content: flex-end;
        margin: 16px 20px 0 0;
    }

    .apod-image-container {
        flex-direction: column;
        align-items: stretch;
    }
}

</style>
</head>
<body>

<nav>
    <div class="nav-left">
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/NASA_logo.svg" alt="NASA Logo">
        <a href="{{ url_for('index') }}" class="logo">SpaceNews</a>
    </div>
    <div class="nav-center">
        <a href="{{ url_for('index') }}">Home</a>
        <div class="dropdown">
            <a href="{{ url_for('apod_page') }}" class="dropbtn active">APOD</a>
            <div class="dropdown-content">
                <a href="{{ url_for('apod_page') }}">APOD</a>
                <a href="{{ url_for('apod_gallery_page') }}">APOD Gallery</a>
            </div>
        </div>
        <a href="{{ url_for('mars_gallery') }}">Mars Gallery</a>
        <a href="{{ url_for('my_gallery') }}">My Gallery</a>
    </div>
    <div class="nav-right">
        {% if current_user %}
        <span>Hello, {{ current_user.username }}</span>
        <a href="{{ url_for('logout') }}">LOG OUT</a>
        {% else %}
        <a href="{{ url_for('login') }}">LOG IN</a>
        <a href="{{ url_for('register') }}" class="primary-action">Register</a>
        {% endif %}
    </div>
</nav>

<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a>
    <span>/</span>
    <span>APOD</span>
</div>

<main class="main-container">
    <!-- APOD Container -->
<div class="apod-container">
        <div class="apod-header">
            <h1>Astronomy Picture of the Day</h1>
        </div>
        
        <div class="apod-meta">
            <div id="apod-title">Loading...</div>
            <div id="apod-date-display">Date</div>
        </div>
        
        <div class="apod-image-container">
            <div id="apod-content" class="loading">Loading today's astronomy picture...</div>
            <div class="action-buttons">
                <button type="button" class="icon-button" id="favorite-btn" aria-label="Add to favorites">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 21s-6.2-3.7-9-7.6C1 11 1 7.8 3.1 5.7a4.4 4.4 0 0 1 6.2.2L12 8.7l2.7-2.8a4.4 4.4 0 0 1 6.2-.2C23 7.8 23 11 21 13.4 18.2 17.3 12 21 12 21z" />
                    </svg>
                </button>
                <a href="#" id="download-link" class="icon-button" aria-label="Download image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 3v14" />
                        <path d="m6 11 6 6 6-6" />
                        <path d="M5 21h14" />
                    </svg>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Explanation outside the container -->
    <div class="apod-explanation">
        <h3>Explanation</h3>
        <p id="apod-explanation-text">Loading explanation...</p>
    </div>
</main>

<footer class="site-footer">
    <p>© 2024 SpaceNew — Astronomy Picture of the Day powered by NASA.</p>
</footer>

<div class="modal-overlay" id="status-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
        <p id="modal-message"></p>
        <div class="modal-actions">
            <button type="button" class="modal-button" id="modal-confirm-btn">ตกลง</button>
        </div>
    </div>
</div>

<script>
// NASA API Configuration
const NASA_API_KEY = '1XxSxhQVZbkFrRUScMZvdeTzV0NfUdZf5ptcIAxY';
const APOD_URL = 'https://api.nasa.gov/planetary/apod';

// Template-driven URLs and state
const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};
const loginUrl = "{{ url_for('login') }}";
const myGalleryUrl = "{{ url_for('my_gallery') }}";
const addToGalleryUrlTemplate = "{{ url_for('add_to_gallery', date='__DATE__PLACEHOLDER__') }}";

// Cached DOM nodes
const apodTitle = document.getElementById('apod-title');
const apodDateDisplay = document.getElementById('apod-date-display');
const apodContent = document.getElementById('apod-content');
const favoriteBtn = document.getElementById('favorite-btn');
const downloadLink = document.getElementById('download-link');
const apodExplanation = document.getElementById('apod-explanation-text');
const modal = document.getElementById('status-modal');
const modalMessage = document.getElementById('modal-message');
const modalConfirmBtn = document.getElementById('modal-confirm-btn');

let modalCallback = null;
let currentApodDate = null;

document.addEventListener('DOMContentLoaded', function () {
    if (favoriteBtn) {
        setFavoriteAvailability(false);
        favoriteBtn.addEventListener('click', handleFavoriteClick);
    }

    if (modalConfirmBtn) {
        modalConfirmBtn.addEventListener('click', closeModal);
    }

    if (modal) {
        modal.addEventListener('click', function (event) {
            if (event.target === modal) {
                closeModal();
            }
        });
    }

    fetchAPOD();
});

function openModal(message, callback) {
    if (!modal || !modalMessage) {
        return;
    }
    modalMessage.textContent = message;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    modalCallback = typeof callback === 'function' ? callback : null;
}

function closeModal() {
    if (!modal) {
        return;
    }
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    if (typeof modalCallback === 'function') {
        const callback = modalCallback;
        modalCallback = null;
        callback();
    }
}

function setFavoriteAvailability(canUse) {
    if (!favoriteBtn) {
        return;
    }
    favoriteBtn.disabled = !canUse;
    favoriteBtn.classList.toggle('disabled', !canUse);
}

async function fetchAPOD() {
    if (apodTitle) {
        apodTitle.textContent = 'Loading...';
    }
    if (apodDateDisplay) {
        apodDateDisplay.textContent = 'Date';
    }
    if (apodContent) {
        apodContent.textContent = "Loading astronomy picture...";
    }
    if (apodExplanation) {
        apodExplanation.textContent = 'Loading explanation...';
    }
    setFavoriteAvailability(false);
    currentApodDate = null;

    try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${APOD_URL}?api_key=${NASA_API_KEY}&date=${today}`);
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }

        const data = await response.json();

        if (apodTitle) {
            apodTitle.textContent = data.title || 'Astronomy Picture of the Day';
        }
        if (apodDateDisplay) {
            apodDateDisplay.textContent = formatDate(data.date);
        }
        if (apodExplanation) {
            apodExplanation.textContent = data.explanation || '';
        }

        if (downloadLink) {
            const assetUrl = data.hdurl || data.url || '#';
            downloadLink.href = assetUrl;
            if (assetUrl === '#') {
                downloadLink.removeAttribute('download');
            } else {
                downloadLink.setAttribute('download', data.title ? data.title.replace(/\s+/g, '_') : 'apod');
            }
        }

        if (data.media_type === 'video') {
            if (apodContent) {
                apodContent.innerHTML = `
                    <iframe
                        src="${data.url}"
                        width="100%"
                        height="400"
                        frameborder="0"
                        allow="autoplay; encrypted-media"
                        allowfullscreen
                        class="apod-video">
                    </iframe>
                `;
            }
            currentApodDate = null;
            setFavoriteAvailability(false);
        } else {
            if (apodContent) {
                apodContent.innerHTML = `
                    <img src="${data.url}" alt="${data.title}" class="apod-image">
                `;
            }
            currentApodDate = data.date;
            setFavoriteAvailability(Boolean(currentApodDate));
        }
    } catch (error) {
        if (apodTitle) {
            apodTitle.textContent = 'Error Loading Content';
        }
        if (apodDateDisplay) {
            apodDateDisplay.textContent = 'Error';
        }
        if (apodContent) {
            apodContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #aaa;">
                    <p>Sorry, unable to load the astronomy picture.</p>
                    <p>Please try again later.</p>
                </div>
            `;
        }
        if (apodExplanation) {
            apodExplanation.textContent = 'Unable to load explanation at this time.';
        }
        setFavoriteAvailability(false);
    }
}

function handleFavoriteClick() {
    if (!currentApodDate) {
        openModal('ไม่พบข้อมูลรูปภาพสำหรับบันทึกในขณะนี้');
        return;
    }

    if (!isLoggedIn) {
        openModal('กรุณาเข้าสู่ระบบก่อนบันทึกรูปภาพ', function () {
            window.location.href = loginUrl;
        });
        return;
    }

    setFavoriteAvailability(false);

    fetch(addToGalleryUrlTemplate.replace('__DATE__PLACEHOLDER__', currentApodDate), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(function (response) {
        if (response.status === 401) {
            openModal('กรุณาเข้าสู่ระบบก่อนบันทึกรูปภาพ', function () {
                window.location.href = loginUrl;
            });
            throw new Error('unauthorized');
        }
        if (!response.ok) {
            throw new Error('request_failed');
        }
        return response.json();
    })
    .then(function (data) {
        if (data && data.success) {
            openModal('บันทึกแล้ว! ตรวจสอบได้ที่ My Gallery', function () {
                window.location.href = myGalleryUrl;
            });
            return;
        }

        if (data && data.error === 'already_saved') {
            openModal('คุณบันทึกรูปนี้ไว้แล้ว ตรวจสอบได้ที่ My Gallery');
            return;
        }

        openModal('เกิดข้อผิดพลาด กรุณาลองอีกครั้ง');
    })
    .catch(function (error) {
        if (error && error.message === 'unauthorized') {
            return;
        }
        openModal('เกิดข้อผิดพลาด กรุณาลองอีกครั้ง');
    })
    .finally(function () {
        setFavoriteAvailability(Boolean(currentApodDate));
    });
}

function formatDate(dateString) {
    if (!dateString) {
        return '';
    }
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}
</script>

</body>
</html>
